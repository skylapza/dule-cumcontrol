<!-- public/master_control.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dule CumControl - Master</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/game_styles.css"> <!-- ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà CSS ‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ -->
  <style>
    /* ************************************************* */
    /* ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö master_control.html */
    /* ************************************************* */

    /* Override body styles from game_styles.css to center content */
    body {
      display: flex;
      flex-direction: column; /* Ensure content stacks vertically */
      justify-content: center; /* Center vertically */
      align-items: center; /* Center horizontally */
      min-height: 100vh; /* Ensure full viewport height */
      padding: 0; /* Remove body padding to allow full flex control */
      margin: 0; /* Remove body margin */
    }

    .game-area-container.master-area {
        max-width: 900px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏° Master */
        padding: 20px; /* ‡∏•‡∏î padding ‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
        gap: 15px; /* ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö */
    }

    /* Style for the video elements to be responsive and larger */
    .video-display-area { /* Container for local and remote videos */
        display: flex;
        flex-direction: column; /* ‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏ö‡∏ö ‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á */
        justify-content: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
        align-items: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
        gap: 1rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô */
        width: 100%; /* ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà */
        margin-bottom: 1rem;
    }

    .video-element {
        width: 100%; /* ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á video-display-area */
        max-width: 450px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß */
        height: auto; /* ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô */
        aspect-ratio: 16 / 9;
        background-color: #2a3547; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
        border-radius: 0.75rem; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô (rounded-lg) */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô */
        object-fit: cover; /* ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
        border: 2px solid #60a5fa; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏ü‡πâ‡∏≤ */
        display: none; /* <<--- IMPORTANT: Hide video elements by default */
    }

    /* Responsive adjustments for videos */
    @media (max-width: 767px) {
        .video-display-area {
            flex-direction: column; /* ‡∏ß‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å */
            align-items: center;
            gap: 1rem;
        }
        .video-element {
            width: 100%; /* ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á video-display-area */
            max-width: 450px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
        }
    }

    /* Camera control buttons */
    .camera-controls button {
        padding: 0.4rem 0.8rem; /* ‡∏•‡∏î padding */
        font-size: 0.9rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
        border-radius: 0.5rem; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô */
    }

    /* Timer text */
    #masterGameTimer {
        font-size: 1.1rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
        margin-bottom: 0.5rem;
    }

    /* BPM display */
    .master-bpm-display-group {
        margin: 1rem auto 0.5rem auto; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô, ‡∏õ‡∏£‡∏±‡∏ö margin ‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á */
        max-width: 350px;
        width: 100%; /* ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á parent ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
    }
    #masterBpmDisplay {
        font-size: 1rem;
    }
    .master-bpm-bar-container {
        height: 1rem;
        margin-top: 0.4rem;
    }
    .master-bpm-buttons button {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
    }
    .master-bpm-max-label {
        font-size: 0.7rem;
    }

    /* Arousal display */
    .arousal-display-group {
        margin: 0.5rem auto 1rem auto; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô, ‡∏õ‡∏£‡∏±‡∏ö margin ‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á */
        max-width: 350px;
        width: 100%; /* ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á parent ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
    }
    #masterArousalDisplay {
        font-size: 1rem;
    }
    .arousal-bar-container {
        height: 1rem;
        margin-top: 0.4rem;
    }
    .arousal-buttons button {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
    }
    .arousal-max-label {
        font-size: 0.7rem;
    }

    /* Master action buttons */
    .master-action-group { /* ‡πÄ‡∏û‡∏¥‡πà‡∏° margin auto ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° */
        display: flex; /* Tailwind already applies flex */
        justify-content: center; /* Tailwind already applies justify-center */
        flex-wrap: wrap; /* Tailwind already applies flex-wrap */
        gap: 0.5rem; /* ‡∏•‡∏î gap ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
        margin: 1rem auto; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö margin ‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á */
        max-width: 500px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) */
    }
    .master-action-group button {
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        /* margin: 0.4rem; (‡∏ñ‡∏π‡∏Å‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô gap ‡πÅ‡∏•‡∏∞ margin ‡∏Ç‡∏≠‡∏á parent ‡πÅ‡∏•‡πâ‡∏ß) */
    }

    /* Notification area adjustments */
    .master-notification {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        margin: 0 auto; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
    }

    /* Headings above videos */
    .video-display-area h3 {
        text-align: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
        margin-bottom: 0.5rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="max-w-2xl game-area-container master-area">
    <h1 class="text-3xl font-bold text-center mb-4">Master</h1>
    <p id="masterGameTimer" class="text-lg">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô: 00:00</p>

    <div class="flex justify-center gap-2 my-2 camera-controls">
      <button id="masterOpenCameraBtn" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
      <button id="masterSwapCameraBtn" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded">‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
      <button id="masterStopCameraBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    </div>

    <div class="video-display-area">
        <div>
            <h3>‡∏Å‡∏•‡πâ‡∏≠‡∏á Player</h3>
            <video id="remoteVideo" class="video-element" autoplay playsinline></video>
        </div>
        <div>
            <h3>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
            <video id="localVideo" class="video-element" autoplay playsinline muted></video>
        </div>
    </div>
    <div id="masterNotification" class="master-notification"></div>

    <!-- Master's command buttons -->
    <div class="master-action-group flex justify-center flex-wrap gap-2 my-4">
        <button id="masterOkBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded master-control-btn">Ok ‚úÖ</button>
        <button id="masterNoBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded master-control-btn">No ‚ùå</button>
        <button id="masterCumNowBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded master-control-btn cum-now-btn">Cum Now üí¶</button>
        <button id="masterDontTouchBtn" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded master-control-btn dont-touch-btn">Don't Touch üö´</button>
    </div>

    <!-- Master's BPM Gauge -->
    <div class="text-center mb-6 master-bpm-display-group">
      <div id="masterBpmDisplay" class="text-lg font-bold">BPM: 120</div>
      <div class="w-full bg-gray-600 h-5 rounded relative overflow-hidden my-2 master-bpm-bar-container">
        <div id="masterBpmBar" class="bg-purple-500 h-full transition-all duration-300" style="width: 50%;"></div>
        <span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs master-bpm-max-label">MAX</span>
      </div>
      <div class="flex justify-center gap-4 master-bpm-buttons">
        <button id="decreaseBpmBtn" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded">‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</button>
        <button id="increaseBpmBtn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</button>
        <button id="stopBpmBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">‡∏´‡∏¢‡∏∏‡∏î/‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
      </div>
    </div>

    <!-- Master's view of Player's Arousal -->
    <div class="text-center mb-6 arousal-display-group">
      <div id="masterArousalDisplay" class="text-lg font-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á Player: 5/10</div>
      <div class="w-full bg-gray-600 h-5 rounded relative overflow-hidden my-2 arousal-bar-container">
        <div id="masterArousalBar" class="bg-red-500 h-full transition-all duration-300" style="width: 50%;"></div>
        <span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs arousal-max-label">CUM</span>
      </div>
    </div>

    <div class="text-center mt-8">
      <button id="backToLobbyBtnMaster" class="underline text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <!-- Removed: <script src="/script.js"></script> as WebRTC logic is now in this file -->

  <script>
    // Global socket connection
    const socket = io();

    // WebRTC related variables
    let peerConnection;
    let localStream;
    let currentFacingMode = 'user'; // 'user' for front camera, 'environment' for back camera

    // Master Game Logic variables
    let masterBpmLevel = 5; // Master's BPM gauge level (1-10)
    const bpmLevels = [60, 80, 100, 120, 140, 160, 180, 200, 240, 280]; // Corresponding BPM values
    const maxBpmLevel = 10;
    let isBpmStopped = false; // New state variable to track if BPM is stopped
    let masterGameElapsedTime = 0;
    let masterElapsedTimeInterval = null;

    // DOM Elements
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const masterGameTimer = document.getElementById('masterGameTimer');
    const masterNotification = document.getElementById('masterNotification');
    const masterBpmDisplay = document.getElementById('masterBpmDisplay');
    const masterBpmBar = document.getElementById('masterBpmBar');
    const increaseBpmBtn = document.getElementById('increaseBpmBtn');
    const decreaseBpmBtn = document.getElementById('decreaseBpmBtn');
    const stopBpmBtn = document.getElementById('stopBpmBtn');
    const masterOkBtn = document.getElementById('masterOkBtn');
    const masterNoBtn = document.getElementById('masterNoBtn');
    const masterCumNowBtn = document.getElementById('masterCumNowBtn');
    const masterDontTouchBtn = document.getElementById('masterDontTouchBtn');
    const masterArousalDisplay = document.getElementById('masterArousalDisplay');
    const masterArousalBar = document.getElementById('masterArousalBar');
    const backToLobbyBtnMaster = document.getElementById('backToLobbyBtnMaster');
    const masterOpenCameraBtn = document.getElementById('masterOpenCameraBtn');
    const masterSwapCameraBtn = document.getElementById('masterSwapCameraBtn');
    const masterStopCameraBtn = document.getElementById('masterStopCameraBtn');


    // Function to show notifications
    function showMasterNotification(message, isError = false) {
        if (masterNotification) {
            masterNotification.textContent = message;
            masterNotification.className = 'master-notification ' + (isError ? 'error' : ''); // Reset classes
            masterNotification.classList.add('show');
            setTimeout(() => {
                masterNotification.classList.remove('show');
            }, 3000);
        }
    }

    // Function to update the display for Master's BPM gauge
    function updateMasterBpmDisplay() {
        const currentBpm = bpmLevels[masterBpmLevel - 1];
        if (masterBpmDisplay) {
            masterBpmDisplay.textContent = `BPM: ${isBpmStopped ? '‡∏´‡∏¢‡∏∏‡∏î' : currentBpm}`;
        }
        if (masterBpmBar) {
            const percentage = (masterBpmLevel / maxBpmLevel) * 100;
            masterBpmBar.style.width = `${percentage}%`;
        }
        // Emit BPM update to Player via Socket.IO
        if (!isBpmStopped) {
            socket.emit('masterCommand', { type: 'bpm_update', bpm: currentBpm });
        } else {
             socket.emit('masterCommand', { type: 'bpm_stop', message: 'Master: Stop!' }); // Ensure Player knows BPM stopped
        }
    }

    // Function to update the display for Master's arousal (Player's arousal)
    function updateMasterArousalDisplay(arousalLevel) {
        if (masterArousalDisplay) {
            masterArousalDisplay.textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á Player: ${arousalLevel}/10`;
        }
        if (masterArousalBar) {
            const percentage = (arousalLevel / 10) * 100;
            masterArousalBar.style.width = `${percentage}%`;
        }
    }

    // Camera and WebRTC Functions
    async function startCamera(facingMode = 'user') {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: facingMode },
          audio: false
        });
        localVideo.srcObject = localStream;
        localVideo.style.display = 'block'; // Show local video when stream starts
        currentFacingMode = facingMode; // Update current facing mode

        // Add tracks to peer connection if it exists
        if (peerConnection) {
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }

      } catch (e) {
        console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ", e);
        showMasterNotification("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + e.message, true);
      }
    }

    function stopCamera() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
        localVideo.srcObject = null;
        localVideo.style.display = 'none'; // Hide local video when stopped
      }
    }

    async function switchCamera() {
      const newFacingMode = (currentFacingMode === 'user' || currentFacingMode === undefined) ? 'environment' : 'user';
      await startCamera(newFacingMode);
    }

    // WebRTC Setup
    function createPeerConnection() {
        peerConnection = new RTCPeerConnection();

        // Add local stream tracks to peer connection
        if (localStream) {
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        }

        // Event: When an ICE candidate is generated
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('signal', { candidate: event.candidate });
            }
        };

        // Event: When remote tracks are received
        peerConnection.ontrack = (event) => {
            if (remoteVideo.srcObject !== event.streams[0]) {
                remoteVideo.srcObject = event.streams[0];
                remoteVideo.style.display = 'block'; // Show remote video when stream is received
                console.log('Received remote stream');
            }
        };
    }

    // Socket.IO Listeners for WebRTC Signaling
    socket.on('paired', async ({ role, room }) => {
        showMasterNotification('‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏°');
        createPeerConnection(); // Create peer connection when paired

        // Master should initiate the offer
        try {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('signal', { sdp: offer });
        } catch (e) {
            console.error("Error creating offer:", e);
            showMasterNotification("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠ WebRTC", true);
        }
    });

    socket.on('signal', async (data) => {
        if (!peerConnection) {
            createPeerConnection();
        }

        if (data.sdp) {
            // Received an offer or answer
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));

            if (data.sdp.type === 'answer') {
                console.log('Received answer from Player');
            } else if (data.sdp.type === 'offer') {
                // If Master receives an offer (unexpected based on our design, but handle defensively)
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('signal', { sdp: answer });
            }
        } else if (data.candidate) {
            // Received an ICE candidate
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    });

    // Handle partner disconnected
    socket.on('partnerDisconnected', (message) => {
        showMasterNotification(message + "\n‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ", true);
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        stopCamera(); // Ensure local camera is off
        remoteVideo.style.display = 'none'; // Hide remote video
        if (masterElapsedTimeInterval) clearInterval(masterElapsedTimeInterval); // Stop timer
        setTimeout(() => {
            window.location.href = '/lobby.html';
        }, 3000); // Redirect after notification
    });


    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        updateMasterBpmDisplay(); // Initial display update
        // Start Master's timer for demo, will be triggered by game start in real app
        let seconds = 0;
        masterElapsedTimeInterval = setInterval(() => {
            seconds++;
            const m = String(Math.floor(seconds / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            masterGameTimer.textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô: ${m}:${s}`;
        }, 1000);

        // BPM control buttons
        if (increaseBpmBtn) {
            increaseBpmBtn.addEventListener('click', () => {
                if (masterBpmLevel < maxBpmLevel) {
                    masterBpmLevel++;
                    isBpmStopped = false; // Ensure it's not stopped when changing speed
                    updateMasterBpmDisplay();
                }
            });
        }
        if (decreaseBpmBtn) {
            decreaseBpmBtn.addEventListener('click', () => {
                if (masterBpmLevel > 1) {
                    masterBpmLevel--;
                    isBpmStopped = false; // Ensure it's not stopped when changing speed
                    updateMasterBpmDisplay();
                }
            });
        }
        // Event listener for the Stop/Start button
        if (stopBpmBtn) {
            stopBpmBtn.addEventListener('click', () => {
                isBpmStopped = !isBpmStopped; // Toggle state
                updateMasterBpmDisplay(); // Update display based on new state
                // Emit command to Player
                if (isBpmStopped) {
                    socket.emit('masterCommand', { type: 'bpm_stop', message: 'Master: Stop!' });
                } else {
                    socket.emit('masterCommand', { type: 'bpm_start', bpm: bpmLevels[masterBpmLevel - 1], message: 'Master: Start!' });
                }
            });
        }

        // Master's command buttons
        if (masterOkBtn) {
            masterOkBtn.addEventListener('click', () => {
                socket.emit('masterCommand', { type: 'ok', message: 'Master: Ok! ‚úÖ‚úÖ‚úÖ' });
            });
        }
        if (masterNoBtn) {
            masterNoBtn.addEventListener('click', () => {
                socket.emit('masterCommand', { type: 'no', message: 'Master: No! ‚ùå‚ùå‚ùå' });
            });
        }
        if (masterCumNowBtn) {
            masterCumNowBtn.addEventListener('click', () => {
                socket.emit('masterCommand', { type: 'cum_now', message: 'Master: Cum Now! üí¶üí¶üí¶' });
            });
        }
        if (masterDontTouchBtn) {
            masterDontTouchBtn.addEventListener('click', () => {
                socket.emit('masterCommand', { type: 'dont_touch', message: 'Master: Don\'t Touch! ÔøΩüö´üö´' });
            });
        }

        // Camera controls
        masterOpenCameraBtn.addEventListener('click', () => startCamera());
        masterSwapCameraBtn.addEventListener('click', switchCamera);
        masterStopCameraBtn.addEventListener('click', stopCamera);

        // Back to Lobby button
        if (backToLobbyBtnMaster) {
            backToLobbyBtnMaster.addEventListener('click', () => {
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                stopCamera();
                remoteVideo.style.display = 'none'; // Ensure remote video is hidden too
                if (masterElapsedTimeInterval) clearInterval(masterElapsedTimeInterval);
                socket.disconnect(); // Inform server about disconnect
                window.location.href = '/lobby.html';
            });
        }
    });

    // Listener for Master to receive Player's arousal updates
    socket.on('playerArousalUpdate', (arousalLevel) => {
        console.log("Master received Player arousal update:", arousalLevel);
        updateMasterArousalDisplay(arousalLevel);
    });

    // Listener for Master side to receive commands from Player
    socket.on('playerCommand', (data) => {
        console.log("Master received command from Player:", data);
        showMasterNotification(data.message);
    });

    // Initial check: if already paired or somehow redirected here, try to setup WebRTC
    socket.on('connect', () => {
        // When reconnected, if already in a room, the server might send 'paired' again
        // Or client might proactively try to recreate peer connection if local storage indicates game state
        // For simplicity, rely on server's 'paired' signal to re-initiate WebRTC
    });
  </script>
</body>
</html>