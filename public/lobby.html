<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lobby</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background: #121212;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: #ffccff;
      margin-bottom: 20px;
    }

    .room-container {
        display: flex;
        flex-wrap: wrap; /* Allow rooms to wrap to the next line */
        justify-content: center; /* Center rooms horizontally */
        gap: 20px; /* Space between rooms */
        margin-bottom: 30px;
        max-width: 90%;
        width: 100%;
    }

    .room {
      display: flex; /* Use flexbox for internal layout */
      flex-direction: column; /* Stack items vertically */
      background: #2e2e2e;
      padding: 15px;
      border-radius: 10px;
      width: 200px; /* Adjust width as needed */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      flex-shrink: 0; /* Prevent shrinking on smaller screens */
    }

    .room h2 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #ffccff;
    }

    .room button {
      margin-top: 10px;
      padding: 8px 16px;
      background: #663399;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-size: 0.95em;
    }

    .room button:hover:enabled {
        background-color: #7a47b1;
    }

    .room button:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .room-status {
        margin-top: 10px;
        font-size: 0.9em;
        color: #bbb;
        min-height: 2em; /* Ensure consistent height */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ready-area {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #444;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .ready-area p {
        margin: 0;
        color: #aaffaa;
        font-weight: bold;
    }

    #chat {
      margin-top: 30px;
      max-width: 450px;
      width: 90%;
      background: #2e2e2e;
      padding: 15px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
    }

    #chat h2 {
        margin-top: 0;
        color: #ffccff;
        margin-bottom: 10px;
    }

    #chatMessages {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      background: #1a1a1a;
      border-radius: 5px;
      text-align: left;
      word-wrap: break-word; /* Allow long words to break */
    }

    .chat-input-area {
        display: flex;
        gap: 5px;
    }

    #chatInput {
      flex-grow: 1;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #444;
      background: #3a3a3a;
      color: white;
      box-sizing: border-box;
    }

    #sendBtn {
      padding: 8px 12px;
      background: #663399;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #sendBtn:hover {
        background-color: #7a47b1;
    }
  </style>
</head>
<body>
  <h1>ล็อบบี้</h1>
  <p id="userCount">ผู้เล่นออนไลน์: 0 คน</p>

  <div class="room-container">
    <!-- Room 1 -->
    <div class="room" id="room-1">
      <h2>Room 1</h2>
      <button onclick="joinRoom(1, 'player')" id="join-player-1">Join as Player</button>
      <button onclick="joinRoom(1, 'master')" id="join-master-1">Join as Master</button>
      <p class="room-status" id="room-status-1">ว่าง</p>
      <div class="ready-area" id="ready-area-1" style="display: none;">
        <p>ผู้เล่นครบแล้ว! กดพร้อมเพื่อเริ่มเกม</p>
        <button onclick="sendReadySignal(1)" id="ready-button-1">พร้อม!</button>
      </div>
    </div>

    <!-- Room 2 -->
    <div class="room" id="room-2">
      <h2>Room 2</h2>
      <button onclick="joinRoom(2, 'player')" id="join-player-2">Join as Player</button>
      <button onclick="joinRoom(2, 'master')" id="join-master-2">Join as Master</button>
      <p class="room-status" id="room-status-2">ว่าง</p>
      <div class="ready-area" id="ready-area-2" style="display: none;">
        <p>ผู้เล่นครบแล้ว! กดพร้อมเพื่อเริ่มเกม</p>
        <button onclick="sendReadySignal(2)" id="ready-button-2">พร้อม!</button>
      </div>
    </div>

    <!-- Room 3 -->
    <div class="room" id="room-3">
      <h2>Room 3</h2>
      <button onclick="joinRoom(3, 'player')" id="join-player-3">Join as Player</button>
      <button onclick="joinRoom(3, 'master')" id="join-master-3">Join as Master</button>
      <p class="room-status" id="room-status-3">ว่าง</p>
      <div class="ready-area" id="ready-area-3" style="display: none;">
        <p>ผู้เล่นครบแล้ว! กดพร้อมเพื่อเริ่มเกม</p>
        <button onclick="sendReadySignal(3)" id="ready-button-3">พร้อม!</button>
      </div>
    </div>

    <!-- เพิ่มห้องได้ตามต้องการ -->

  </div>

  <div id="chat">
    <h2>แชท</h2>
    <div id="chatMessages"></div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="พิมพ์ข้อความ...">
        <button id="sendBtn">ส่ง</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let selectedRoom = null;
    let selectedRole = null;
    let username = localStorage.getItem("username");
    let hasJoinedRoom = false; // Flag เพื่อติดตามว่าผู้เล่นได้เข้าร่วมห้องแล้วหรือไม่

    // จำนวนห้องทั้งหมดในหน้า Lobby (ต้องตรงกับจำนวนห้องใน HTML)
    const TOTAL_ROOMS = 3; 

    document.addEventListener('DOMContentLoaded', () => {
        if (!username) {
            alert("กรุณาใส่ชื่อผู้ใช้งานจากหน้าแรกก่อน!");
            window.location.href = "/";
            return;
        }

        const chatInput = document.getElementById("chatInput");
        const sendBtn = document.getElementById("sendBtn");

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // เมื่อเชื่อมต่อ socket สำเร็จ
        socket.on('connect', () => {
            console.log('Connected to socket, requesting room status.');
            // ตรวจสอบว่าผู้ใช้นี้เคยเข้าร่วมห้องก่อนหน้านี้หรือไม่
            const storedRoom = localStorage.getItem('lastRoom');
            const storedRole = localStorage.getItem('lastRole');

            if (storedRoom && storedRole) {
                // ถ้าเคย, ให้ส่ง Event ไปถาม Server ว่ายังอยู่ในห้องนั้นอยู่ไหม
                selectedRoom = parseInt(storedRoom);
                selectedRole = storedRole;
                hasJoinedRoom = true; // ตั้งค่าชั่วคราวเป็น true เพื่อให้ปุ่มถูกปิดในขณะที่รอการยืนยันจาก Server
                disableAllJoinButtons(); // ปิดปุ่มไว้ก่อน
                const statusElement = document.getElementById(`room-status-${selectedRoom}`);
                if (statusElement) {
                    statusElement.textContent = `กำลังตรวจสอบสถานะห้องสำหรับ ${selectedRole}...`;
                }
                socket.emit('checkMyRoomStatus', { room: selectedRoom, role: selectedRole });
            } else {
                 // ถ้าไม่เคย ให้รีเซ็ตสถานะและขอสถานะห้องทั้งหมดจากเซิร์ฟเวอร์
                 resetLocalStateAndEnableButtons(); // เพิ่มการเรียก reset
                 socket.emit('requestRoomStatus'); 
            }
        });
    });

    function sendMessage() {
        const chatInput = document.getElementById("chatInput");
        const text = chatInput.value.trim();
        if (text) {
            // ถ้าอยู่ในห้องใดๆ ก็จะส่งข้อความเข้าห้องนั้น
            // ถ้าไม่, จะส่งข้อความรวม (ให้ server จัดการ)
            socket.emit("chatMessage", { room: selectedRoom, text: text, user: username }); 
            chatInput.value = "";
        }
    }

    function sendReadySignal(roomNumber) {
        if (!username || selectedRoom !== roomNumber || !hasJoinedRoom) {
            alert("มีข้อผิดพลาด! กรุณาลองใหม่.");
            return;
        }
        socket.emit("playerReady", { room: roomNumber, role: selectedRole });
        const readyBtn = document.getElementById(`ready-button-${roomNumber}`);
        if (readyBtn) {
            readyBtn.disabled = true; // ปิดปุ่ม "พร้อม" ชั่วคราว
            readyBtn.textContent = "รอการยืนยันจากคู่...";
        }
    }

    function joinRoom(roomNumber, role) {
        if (!username) {
            alert("กรุณาใส่ชื่อผู้ใช้งานจากหน้าแรกก่อน!");
            window.location.href = "/";
            return;
        }
        if (hasJoinedRoom) {
            alert("คุณได้เข้าร่วมห้องแล้ว หรือกำลังรอการจับคู่");
            return;
        }

        selectedRoom = roomNumber;
        selectedRole = role;
        
        // เก็บข้อมูลห้องและบทบาทไว้ใน localStorage (เผื่อรีเฟรชหน้า)
        localStorage.setItem('lastRoom', roomNumber);
        localStorage.setItem('lastRole', role);

        // ส่งข้อมูลการเข้าร่วมห้องไปให้เซิร์ฟเวอร์
        socket.emit("joinRoom", { room: roomNumber, role: role, name: username });

        // แสดงสถานะ "กำลังรอ" ทันทีที่ผู้เล่นกดเข้าร่วม
        const statusElement = document.getElementById(`room-status-${roomNumber}`);
        if (statusElement) {
            statusElement.textContent = `กำลังรอคู่สำหรับ ${role}...`;
        }
        
        // ปิดปุ่ม "Join" ทั้งหมดในห้องนั้นๆ และห้องอื่นๆ
        disableAllJoinButtons();
        // ตั้งค่า flag ว่าผู้เล่นได้เข้าร่วมห้องแล้ว
        hasJoinedRoom = true; 
    }

    function disableAllJoinButtons() {
        for (let i = 1; i <= TOTAL_ROOMS; i++) {
            const playerBtn = document.getElementById(`join-player-${i}`);
            const masterBtn = document.getElementById(`join-master-${i}`);
            if (playerBtn) playerBtn.disabled = true;
            if (masterBtn) masterBtn.disabled = true;
        }
    }

    function enableAllJoinButtons() {
        for (let i = 1; i <= TOTAL_ROOMS; i++) {
            const playerBtn = document.getElementById(`join-player-${i}`);
            const masterBtn = document.getElementById(`join-master-${i}`);
            // ตรวจสอบว่าปุ่มนั้นมีอยู่จริงก่อนที่จะเข้าถึง .disabled
            if (playerBtn) playerBtn.disabled = false;
            if (masterBtn) masterBtn.disabled = false;
            // รีเซ็ตสถานะปุ่มพร้อมและข้อความ
            const readyArea = document.getElementById(`ready-area-${i}`);
            if (readyArea) readyArea.style.display = 'none'; // ซ่อน ready area
            const readyBtn = document.getElementById(`ready-button-${i}`);
            if (readyBtn) {
                readyBtn.disabled = false;
                readyBtn.textContent = "พร้อม!";
            }
            // รีเซ็ตข้อความสถานะห้อง
            const statusElement = document.getElementById(`room-status-${i}`);
            if (statusElement) statusElement.textContent = 'ว่าง';
        }
        // ตั้งค่า hasJoinedRoom เป็น false เมื่อมีการเปิดปุ่มทั้งหมด
        hasJoinedRoom = false; 
        selectedRoom = null;
        selectedRole = null;
        localStorage.removeItem('lastRoom');
        localStorage.removeItem('lastRole');
    }

    // Listener สำหรับการอัปเดตสถานะห้องจากเซิร์ฟเวอร์
    socket.on("roomStatusUpdate", (data) => {
        // data จะมี { room: roomNumber, player: playerName, master: masterName, readyToStart: boolean, playerReady: boolean, masterReady: boolean }
        const roomDiv = document.getElementById(`room-${data.room}`);
        if (!roomDiv) return;

        const statusElement = document.getElementById(`room-status-${data.room}`);
        const readyArea = document.getElementById(`ready-area-${data.room}`);
        const readyBtn = document.getElementById(`ready-button-${data.room}`);
        
        // อัปเดตสถานะผู้เล่นในห้อง
        let statusText = "ว่าง";
        if (data.player && data.master) {
            statusText = `ครบ: ${data.player} (Player), ${data.master} (Master)`;
            // แสดงปุ่มพร้อม ถ้าเราอยู่ในห้องนี้
            if (data.room === selectedRoom && hasJoinedRoom) { 
                readyArea.style.display = 'flex'; // ใช้ flex เพื่อจัดปุ่มให้สวยงาม
                if (readyBtn) {
                    if (selectedRole === 'player' && data.playerReady) { // เราพร้อมแล้ว
                        readyBtn.disabled = true;
                        readyBtn.textContent = "รอ Master กดยืนยัน...";
                    } else if (selectedRole === 'master' && data.masterReady) { // เราพร้อมแล้ว
                        readyBtn.disabled = true;
                        readyBtn.textContent = "รอ Player กดยืนยัน...";
                    } else { // เรายังไม่พร้อม
                        readyBtn.disabled = false;
                        readyBtn.textContent = "พร้อม!";
                    }

                    if (data.playerReady && data.masterReady) {
                        readyBtn.textContent = "ทั้งคู่พร้อมแล้ว! รอเริ่มเกม...";
                        readyBtn.disabled = true;
                    }
                }
            } else { // เราไม่ได้อยู่ในห้องนี้
                readyArea.style.display = 'none';
            }
        } else if (data.player) {
            statusText = `มี Player: ${data.player} | รอ Master`;
            readyArea.style.display = 'none';
        } else if (data.master) {
            statusText = `มี Master: ${data.master} | รอ Player`;
            readyArea.style.display = 'none';
        }
        statusElement.textContent = statusText;

        // จัดการสถานะปุ่ม Join สำหรับทุกห้อง
        for (let roomNum = 1; roomNum <= TOTAL_ROOMS; roomNum++) {
            const pBtn = document.getElementById(`join-player-${roomNum}`);
            const mBtn = document.getElementById(`join-master-${roomNum}`);
            
            const currentRoomData = (data.room === roomNum) ? data : {};

            if (pBtn) {
                // ปิดปุ่มถ้าห้องนั้นมี Player หรือถ้าเราเข้าร่วมห้องอื่นอยู่แล้ว
                pBtn.disabled = !!currentRoomData.player || hasJoinedRoom;
            }
            if (mBtn) {
                // ปิดปุ่มถ้าห้องนั้นมี Master หรือถ้าเราเข้าร่วมห้องอื่นอยู่แล้ว
                mBtn.disabled = !!currentRoomData.master || hasJoinedRoom;
            }
            
            // หากห้องนี้คือห้องที่เราเข้าร่วมอยู่, ให้ปิดปุ่ม Join ของห้องนี้เสมอ
            if (selectedRoom === roomNum && hasJoinedRoom) {
                if (pBtn) pBtn.disabled = true;
                if (mBtn) mBtn.disabled = true;
            }
        }
    });

    // Listener ใหม่: รับการตอบกลับสถานะห้องจาก Server
    socket.on('myRoomStatusResponse', ({ inRoom, room, role, roomData }) => {
        if (inRoom) {
            console.log(`Server confirms you are still ${role} in Room ${room}.`);
            selectedRoom = room;
            selectedRole = role;
            hasJoinedRoom = true;
            // อัปเดต UI ด้วย roomData ที่ Server ส่งมา (อาจจะเรียก requestRoomStatus อีกครั้ง)
            socket.emit('requestRoomStatus'); 
        } else {
            console.log('Server confirms you are not in any active room. Resetting local state.');
            // หาก Server บอกว่าไม่อยู่ในห้อง ให้รีเซ็ตสถานะ Client และเปิดปุ่มทั้งหมด
            resetLocalStateAndEnableButtons(); // ใช้ฟังก์ชันนี้เพื่อรีเซ็ตทั้งหมด
        }
    });

    // ฟังก์ชันสำหรับรีเซ็ตสถานะ Client และเปิดปุ่ม Join ทั้งหมด
    function resetLocalStateAndEnableButtons() {
        selectedRoom = null;
        selectedRole = null;
        hasJoinedRoom = false;
        localStorage.removeItem('lastRoom');
        localStorage.removeItem('lastRole');
        enableAllJoinButtons(); // เปิดปุ่ม Join ทั้งหมด
        socket.emit('requestRoomStatus'); // ขอสถานะห้องอีกครั้งเพื่อแสดงผลที่ถูกต้อง
    }


    socket.on("userCount", count => {
        document.getElementById("userCount").textContent = `ผู้เล่นออนไลน์: ${count} คน`;
    });

    socket.on("chatMessage", ({ user, text }) => {
        const box = document.getElementById("chatMessages");
        const msg = document.createElement("div");
        msg.textContent = `${user}: ${text}`;
        box.appendChild(msg);
        box.scrollTop = box.scrollHeight;
    });

    socket.on('redirect', (url) => {
        console.log('Server สั่งให้เปลี่ยนหน้าไป:', url);
        // ล้างค่าใน localStorage เมื่อกำลังจะเปลี่ยนหน้าไปหน้าเกม
        localStorage.removeItem('lastRoom');
        localStorage.removeItem('lastRole');
        window.location.href = url;
    });

    socket.on('roomError', (message) => {
        alert(message);
        // ถ้าเกิด Error ตอน join room, ให้ผู้เล่นสามารถเลือกห้องใหม่ได้
        resetLocalStateAndEnableButtons(); // ใช้ฟังก์ชันนี้เพื่อรีเซ็ตทั้งหมด
    });

    socket.on('partnerDisconnected', (message) => {
        alert(message + "\nคุณจะถูกนำกลับไปยังล็อบบี้");
        // รีเซ็ตสถานะ Client เพื่อให้เข้าร่วมห้องใหม่ได้
        resetLocalStateAndEnableButtons(); // ใช้ฟังก์ชันนี้เพื่อรีเซ็ตทั้งหมด
    });

  </script>
</body>
</html>

